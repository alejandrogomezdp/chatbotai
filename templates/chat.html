<!doctype html>
<html>
    <head>
        <title>Chat</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: #f5f5f5;
            }

            .container {
                min-width: 1em;
                max-width: 80em;
                margin: 0 auto;
            }

            .chat-container {
                border: 1px solid #ccc;
                background-color: #fff;
                margin: 20px 0;
                padding: 20px;
                height: 400px;
                overflow-y: scroll;
            }

            .chat-message {
                margin-bottom: 20px;
            }

            .input-container {
                display: flex;
                justify-content: space-between;
                margin: 20px 0;
            }

            .input-container input {
                flex-grow: 1;
                margin-right: 20px;
                padding: 10px;
                border: 1px solid #ccc;
            }

            .input-container button {
                padding: 10px 20px;
                border: none;
                background-color: #007bff;
                color: #fff;
                cursor: pointer;
            }

            .input-container button:hover {
                background-color: #0056b3;
            }

            .alert-danger {
                margin: auto;
                align-items: center;                           
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Chat</h1>
            {% with messages = get_flashed_messages(with_categories=false) %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div class="chat-container">
                {% for conversation in conversations %}
                    <div class="chat-message">
                        <p><strong>User:</strong> {{ conversation.user_input }}</p>
                        <p><strong>Chatbot:</strong> {{ conversation.chatbot_response }}</p>
                    </div>
                {% endfor %}
            </div>
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Escribe un mensaje...">
                <button id="sendButton">Enviar</button>
            </div>
        </div>

        <script>
            function scrollToBottom() {
                const chatContainer = document.querySelector('.chat-container');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function addMessageToChat(role, content) {
                const chatContainer = document.querySelector('.chat-container');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                const roleTag = document.createElement('strong');
                roleTag.textContent = role.charAt(0).toUpperCase() + role.slice(1);
                const messageContent = document.createElement('p');
                messageContent.innerHTML = `<strong>${roleTag.textContent}:</strong> ${content}`;
                messageDiv.appendChild(messageContent);
                chatContainer.appendChild(messageDiv);
            }

            function postUserMessage(message) {
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    addMessageToChat('chatbot', data.response);
                    scrollToBottom();
                })
                .catch(error => console.error(error));
            }

            document.getElementById('sendButton').addEventListener('click', function() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();
                if (message !== '') {
                    addMessageToChat('user', message);
                    messageInput.value = '';
                    scrollToBottom();
                    postUserMessage(message);
                }
            });

            document.getElementById('messageInput').addEventListener('keydown', function(event) {
                if (event.keyCode === 13) {
                    event.preventDefault();
                    document.getElementById('sendButton').click();
                }
            });

            scrollToBottom();
        </script>
    </body>
</html>
